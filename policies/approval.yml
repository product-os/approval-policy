policy:
  approval:
    - or:
        - approved via self-certify or review
        - approved via non-author review
        - approved via non-author review with invalidate on push
        - auto-approved via no-review label
        - auto-approved via author is bot
  disapproval:
    requires:
      permissions: ["write"]
    options:
      methods:
        disapprove:
          comments:
            - ":-1:"
            - "ðŸ‘Ž"
          github_review: true
        revoke:
          comments: []
          comment_patterns: &approvalCommentPatterns
            - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
            - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
            - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
            - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm!
          github_review: true

approval_rules:
  # exclude forks, exclude balena-io, allow comments, allow self-certify
  - name: approved via self-certify or review

    if:
      # exclude forks from this rule
      from_branch:
        pattern: "^[^:]+$"
      # exclude balena-io from this rule
      repository:
        not_matches:
          - "balena-io/.*"

    requires:
      count: 1
      permissions: ["write"]

    options:
      allow_author: false
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns: *approvalCommentPatterns
        github_review: true

  # exclude forks, allow balena-io, allow comments, disable self-certify
  - name: approved via non-author review

    if:
      # exclude forks from this rule
      from_branch:
        pattern: "^[^:]+$"

      # allow balena-io in this rule

    requires:
      count: 1
      permissions: ["write"]

    options:
      allow_author: false
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns: *approvalCommentPatterns
        github_review: true

  # allow forks, allow balena-io, allow comments, disable self-certify, invalidate on push
  - name: approved via non-author review with invalidate on push

    # allow forks in this rule
    # allow balena-io in this rule

    requires:
      count: 1
      permissions: ["write"]

    options:
      allow_author: false
      allow_contributor: true
      invalidate_on_push: true
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns: *approvalCommentPatterns
        github_review: true

  - name: auto-approved via no-review label
    if:
      has_labels: ["no-review"]
      repository:
        not_matches: &adminRepositories
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"
          - "balena-io/renovate-config"
          - "balena-os/renovate-config"
          - "product-os/renovate-config"

  - name: auto-approved via author is bot
    if:
      has_author_in:
        users:
          - "balena-renovate[bot]"
          - "flowzone-app[bot]"
      repository:
        not_matches: *adminRepositories
      author_is_only_contributor: true
