policy:
  approval:
    - or:
        - reviewers have approved internal contributions
        - reviewers have approved with invalidate on push
        - auto-approved via no-review label
        - auto-approved via minor label
        - auto-approved via patch label
        - auto-approved via digest label
        - auto-approved via pinDigest label
        - auto-approved via pin label
  disapproval:
    requires:
      permissions: ["write"]
    options:
      methods:
        disapprove:
          comments:
            - ":-1:"
            - "ðŸ‘Ž"
          github_review: true
        revoke:
          comments: []
          comment_patterns: &approvalCommentPatterns
            - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
            - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
            - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
            - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm!
          github_review: true

approval_rules:
  - name: reviewers have approved internal contributions

    if:
      # exclude forks from this rule
      from_branch:
        pattern: "^[^:]+$"

    requires:
      count: 1
      permissions: ["write"]

    options:
      allow_author: true
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns: *approvalCommentPatterns
        github_review: true

  - name: reviewers have approved with invalidate on push

    requires:
      count: 1
      permissions: ["write"]

    options:
      allow_author: true
      allow_contributor: true
      # FIXME: set true after https://github.com/palantir/policy-bot/pull/602 merges
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
          comments: []
          comment_patterns: *approvalCommentPatterns
          github_review: true

  - name: auto-approved via no-review label
    if:
      has_labels: ["no-review"]
      only_has_contributors_in:
        users:
          - "balena-renovate[bot]"
          - "flowzone-app[bot]"
      repository:
        not_matches: &adminRepositories
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"
          - "balena-io/renovate-config"
          - "balena-os/renovate-config"
          - "product-os/renovate-config"

  - name: auto-approved via minor label
    if: &renovateConditions
      has_labels: ["minor"]
      has_author_in:
        users: ["balena-renovate[bot]"]
      repository:
        not_matches: *adminRepositories
      author_is_only_contributor: true

  - name: auto-approved via patch label
    if:
      <<: *renovateConditions
      has_labels: ["patch"]

  - name: auto-approved via digest label
    if:
      <<: *renovateConditions
      has_labels: ["digest"]

  - name: auto-approved via pinDigest label
    if:
      <<: *renovateConditions
      has_labels: ["pinDigest"]

  - name: auto-approved via pin label
    if:
      <<: *renovateConditions
      has_labels: ["pin"]
