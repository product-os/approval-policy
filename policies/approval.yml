policy:
  approval:
    - or:
        - sudoers have approved
        - members have approved
        - members have approved fork
        - has renovate minor labels
        - has renovate patch labels
        - has renovate digest labels
        - has renovate pinDigest labels
        - has renovate pin labels
        - has label no-review

approval_rules:
  # some repositories require sudoers approval
  - name: sudoers have approved

    if:
      from_branch: &excludeForks
        pattern: "^[^:]+$"

    requires: &requireSudoers
      count: 1
      teams:
        - "balenaltd/sudoers"

    options: &defaultOptions
      allow_author: true
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns:
          - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
          - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
          - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
          - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm
        github_review: true

  # remaining repositories can be approved by any team member
  - name: members have approved

    if:
      from_branch:
        <<: *excludeForks
      # exclude the following repositories that require sudoers approval
      repository: &excludeRestrictedRepositories
        not_matches:
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"

    requires: &requireMembers
      count: 1
      teams:
        - "balena-fleetops/balena-dev"
        - "balena-io/balena-dev"
        - "balena-io-examples/balena-dev"
        - "balena-io-experimental/balena-dev"
        - "balena-io-hardware/balena-dev"
        - "balena-io-library/resin-dev"
        - "balena-io-modules/balena-dev"
        - "balena-labs-projects/balena-dev"
        - "balena-labs-research/balena-dev"
        - "balena-os/balena-dev"
        - "balenablocks/balena"
        - "company-os/balena-dev"
        - "people-os/balena-dev"
        - "product-os/balena-dev"

    options:
      <<: *defaultOptions

  # allow forks but disallow comments and invalidate on push
  - name: members have approved fork

    if:
      repository:
        <<: *excludeRestrictedRepositories

    requires:
      <<: *requireMembers

    options:
      <<: *defaultOptions
      # invalidate on push for forks
      invalidate_on_push: true

  - name: has renovate minor labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "minor"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate patch labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "patch"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate digest labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "digest"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate pinDigest labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "pinDigest"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate pin labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "pin"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has label no-review
    if:
      has_labels:
        - "no-review"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories
