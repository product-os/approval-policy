policy:
  approval:
    - or:
        - sudoers have approved for team member author
        - sudoers have approved for any author
        - team members have approved for team member author
        - team members have approved for any author
        - auto-approve renovate author with minor label
        - auto-approve renovate author with patch label
        - auto-approve renovate author with digest label
        - auto-approve renovate author with pinDigest label
        - auto-approve renovate author with pin label
        - auto-approve team member author with no-review label
  disapproval:
    requires:
      teams: &approvalTeams
        - "balena-fleetops/balena-dev"
        - "balena-io/balena-dev"
        - "balena-io-examples/balena-dev"
        - "balena-io-experimental/balena-dev"
        - "balena-io-hardware/balena-dev"
        - "balena-io-library/resin-dev"
        - "balena-io-modules/balena-dev"
        - "balena-labs-projects/balena-dev"
        - "balena-labs-research/balena-dev"
        - "balena-os/balena-dev"
        - "balenablocks/balena"
        - "company-os/balena-dev"
        - "people-os/balena-dev"
        - "product-os/balena-dev"
    options:
      methods:
        disapprove:
          comments:
            - ":-1:"
            - "ðŸ‘Ž"
          github_review: true
        revoke:
          comments: []
          comment_patterns: &approvalCommentPatterns
            - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
            - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
            - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
            - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm!
          github_review: true

approval_rules:
  - name: sudoers have approved for team member author

    if:
      has_author_in:
        teams: *approvalTeams

    requires:
      count: 1
      teams: ["balenaltd/sudoers"]

    options: &approvalOptions
      allow_author: true
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns: *approvalCommentPatterns
        github_review: true

  # invalidate on push
  - name: sudoers have approved for any author

    requires:
      count: 1
      teams: ["balenaltd/sudoers"]

    options:
      <<: *approvalOptions
      invalidate_on_push: true

  - name: team members have approved for team member author

    if:
      has_author_in:
        teams: *approvalTeams
      repository:
        not_matches: &restrictedRepositories
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"

    requires:
      count: 1
      teams: *approvalTeams

    options:
      <<: *approvalOptions

  # invalidate on push
  - name: team members have approved for any author

    if:
      repository:
        not_matches: *restrictedRepositories

    requires:
      count: 1
      teams: *approvalTeams

    options:
      <<: *approvalOptions
      invalidate_on_push: true

  - name: auto-approve renovate author with minor label
    if: &renovateConditions
      has_labels: ["minor"]
      has_author_in:
        users: ["balena-renovate[bot]"]
      repository:
        not_matches: *restrictedRepositories

  - name: auto-approve renovate author with patch label
    if:
      <<: *renovateConditions
      has_labels: ["patch"]

  - name: auto-approve renovate author with digest label
    if:
      <<: *renovateConditions
      has_labels: ["digest"]

  - name: auto-approve renovate author with pinDigest label
    if:
      <<: *renovateConditions
      has_labels: ["pinDigest"]

  - name: auto-approve renovate author with pin label
    if:
      <<: *renovateConditions
      has_labels: ["pin"]

  - name: auto-approve team member author with no-review label
    if:
      has_labels: ["no-review"]
      has_author_in:
        teams: *approvalTeams
      repository:
        not_matches: *restrictedRepositories
