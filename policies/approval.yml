policy:
  approval:
    - or:
        # for admin repositories, only sudoers team members can approve
        - sudoers have approved sudoers contributions
        # for admin repositories, if the contributors are not all sudoers team members, then invalidate on push
        - sudoers have approved but invalidate on push
        # for environment repositories, only sudoers and reliability team members can approve
        - reliability have approved reliability contributions
        # for environment repositories, if the contributors are not all sudoers/reliability team members, then invalidate on push
        - reliability have approved but invalidate on push
        # for other repositories, only balena-dev team members can approve
        - balena-devs have approved balena-devs contributions
        # for other repositories, if the contributors are not all balena-dev team members, then invalidate on push
        - balena-devs have approved but invalidate on push
        # for other repositories, allow auto-approve via labels for team members and some bots
        - auto-approve contributions with no-review label
        # for other repositories, allow auto-approve via labels for renovate user
        - auto-approve renovate author with minor label
        - auto-approve renovate author with patch label
        - auto-approve renovate author with digest label
        - auto-approve renovate author with pinDigest label
        - auto-approve renovate author with pin label
  disapproval:
    requires:
      teams: &balenaDevs
        - "balena-fleetops/balena-dev"
        - "balena-io/balena-dev"
        - "balena-io-examples/balena-dev"
        - "balena-io-experimental/balena-dev"
        - "balena-io-hardware/balena-dev"
        - "balena-io-library/resin-dev"
        - "balena-io-modules/balena-dev"
        - "balena-labs-projects/balena-dev"
        - "balena-labs-research/balena-dev"
        - "balena-os/balena-dev"
        - "balenablocks/balena"
        - "company-os/balena-dev"
        - "people-os/balena-dev"
        - "product-os/balena-dev"
    options:
      methods:
        disapprove:
          comments:
            - ":-1:"
            - "ðŸ‘Ž"
          github_review: true
        revoke:
          comments: []
          comment_patterns: &approvalCommentPatterns
            - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
            - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
            - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
            - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm!
          github_review: true

approval_rules:
  - name: sudoers have approved sudoers contributions

    if:
      only_has_contributors_in:
        teams: ["balenaltd/sudoers"]
      repository:
        # admin repositories require sudoers approval, and are not subject to other rules
        matches: &adminRepositories
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"

    requires:
      count: 1
      teams: ["balenaltd/sudoers"]

    options: &approvalOptions
      allow_author: true
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns: *approvalCommentPatterns
        github_review: true

  # same as above but allow any contributors and invalidate on push
  - name: sudoers have approved but invalidate on push

    if:
      repository:
        matches: *adminRepositories

    requires:
      count: 1
      teams: ["balenaltd/sudoers"]

    options:
      <<: *approvalOptions
      invalidate_on_push: true

  - name: reliability have approved reliability contributions

    if:
      only_has_contributors_in:
        teams: ["balenaltd/sudoers", "balenaltd/reliability"]
      repository:
        # environment repositories require reliability/sudoers approval, and are not subject to other rules
        matches: &environmentRepositories
          - "balena-io/environment-production"
          - "balena-io/environment-staging"
          - "product-os/environment-production"
          - "product-os/environment-staging"

    requires:
      count: 1
      teams: ["balenaltd/sudoers", "balenaltd/reliability"]

    options:
      <<: *approvalOptions

  # same as above but allow any contributors and invalidate on push
  - name: reliability have approved but invalidate on push

    if:
      repository:
        matches: *environmentRepositories

    requires:
      count: 1
      teams: ["balenaltd/sudoers", "balenaltd/reliability"]

    options:
      <<: *approvalOptions
      invalidate_on_push: true

  - name: balena-devs have approved balena-devs contributions

    if:
      only_has_contributors_in:
        teams: *balenaDevs
      repository:
        # restrictedRepositories should be adminRepositories + environmentRepositories
        not_matches: &restrictedRepositories
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"
          - "balena-io/environment-production"
          - "balena-io/environment-staging"
          - "product-os/environment-production"
          - "product-os/environment-staging"

    requires:
      count: 1
      teams: *balenaDevs

    options:
      <<: *approvalOptions

  # same as above but allow any contributors and invalidate on push
  - name: balena-devs have approved but invalidate on push

    if:
      repository:
        not_matches: *restrictedRepositories

    requires:
      count: 1
      teams: *balenaDevs

    options:
      <<: *approvalOptions
      invalidate_on_push: true

  - name: auto-approve contributions with no-review label
    if:
      has_labels: ["no-review"]
      only_has_contributors_in:
        users:
          - "balena-renovate[bot]"
          - "flowzone-app[bot]"
        teams: *balenaDevs
      repository:
        not_matches: *adminRepositories

  - name: auto-approve renovate author with minor label
    if: &renovateConditions
      has_labels: ["minor"]
      has_author_in:
        users: ["balena-renovate[bot]"]
      repository:
        not_matches: *adminRepositories
      author_is_only_contributor: true

  - name: auto-approve renovate author with patch label
    if:
      <<: *renovateConditions
      has_labels: ["patch"]

  - name: auto-approve renovate author with digest label
    if:
      <<: *renovateConditions
      has_labels: ["digest"]

  - name: auto-approve renovate author with pinDigest label
    if:
      <<: *renovateConditions
      has_labels: ["pinDigest"]

  - name: auto-approve renovate author with pin label
    if:
      <<: *renovateConditions
      has_labels: ["pin"]
