policy:
  approval:
    - or:
        - reviewers have approved internal contributions
        - reviewers have approved with invalidate on push
        - auto-approved via no-review label
        - auto-approved via author is bot
  disapproval:
    requires:
      permissions: ["write"]
    options:
      methods:
        disapprove:
          comments:
            - ":-1:"
            - "ðŸ‘Ž"
          github_review: true
        revoke:
          comments: []
          comment_patterns: &approvalCommentPatterns
            - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
            - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
            - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
            - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm!
          github_review: true

approval_rules:
  - name: reviewers have approved internal contributions

    if:
      # exclude forks from this rule
      from_branch:
        pattern: "^[^:]+$"

    requires:
      count: 1
      permissions: ["write"]

    options:
      allow_author: true
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns: *approvalCommentPatterns
        github_review: true

  # forks are allowed in this block so the rules are strict
  # like invalidate on push and no self-certify
  - name: reviewers have approved with invalidate on push

    requires:
      count: 1
      permissions: ["write"]

    options:
      # disable self-certify
      # If true, approvals by the author of a pull request are considered when
      # calculating the status. False by default.
      allow_author: false
      # If true, the approvals of someone who has committed to the pull request are
      # considered when calculating the status. The pull request author is considered
      # a contributor. If allow_author and allow_contributor would disagree, this option
      # always wins. False by default.
      allow_contributor: false
      invalidate_on_push: true
      ignore_edited_comments: true

      methods:
          comments: []
          comment_patterns: *approvalCommentPatterns
          github_review: true

  - name: auto-approved via no-review label
    if:
      has_labels: ["no-review"]
      repository:
        not_matches:
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"
          - "balena-io/renovate-config"
          - "balena-os/renovate-config"
          - "product-os/renovate-config"

  - name: auto-approved via author is bot
    if:
      has_author_in:
        users:
          - "balena-renovate[bot]"
          - "flowzone-app[bot]"
      repository:
        not_matches:
          - "product-os/policies"
          - "balenaltd/admins"
      only_has_contributors_in:
        users:
          - "balena-renovate[bot]"
          - "flowzone-app[bot]"
          - "github-actions[bot]"
