policy:
  approval:
    - or:
        - sudoers have approved
        - members have approved
        - members have approved fork
        - has renovate minor labels
        - has renovate patch labels
        - has renovate digest labels
        - has renovate pinDigest labels
        - has renovate pin labels
        - has label no-review

approval_rules:
  # some repositories require sudoers approval
  - name: sudoers have approved

    if:
      # exclude forks from this rule
      from_branch:
        pattern: "^[^:]+$"
      # include the following repositories that require sudoers approval
      repository:
        matches:
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"

    requires:
      count: 1
      teams:
        - "balenaltd/sudoers"

    options: &options
      allow_author: true
      allow_contributor: true
      invalidate_on_push: false

      methods:
        comments: []
        comment_patterns:
          - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
          - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
          - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
          - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm
        github_review: true

  # remaining repositories can be approved by any team member
  - name: members have approved

    if:
      # exclude forks from this rule
      from_branch:
        pattern: "^[^:]+$"
      # exclude the following repositories that require sudoers approval
      repository:
        not_matches:
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"

    requires: &requireMembers
      count: 1
      permissions: ["write"]
      organizations:
        - "balena-fleetops"
        - "balena-io"
        - "balena-io-examples"
        - "balena-io-experimental"
        - "balena-io-hardware"
        - "balena-io-incubator"
        - "balena-io-library"
        - "balena-io-modules"
        - "balena-io-projects"
        - "balena-io-security"
        - "balena-labs-projects"
        - "balena-labs-research"
        - "balena-os"
        - "balenalabs"
        - "balenalabs-incubator"
        - "balenaltd"
        - "company-os"
        - "people-os"
        - "product-os"
        - "product-os-test"
      teams:
        - "balena-fleetops/balena-dev"
        - "balena-io/balena-dev"
        - "balena-io-examples/balena-dev"
        - "balena-io-experimental/balena-dev"
        - "balena-io-hardware/balena-dev"
        - "balena-io-library/resin-dev"
        - "balena-io-modules/balena-dev"
        - "balena-labs-projects/balena-dev"
        - "balena-labs-research/balena-dev"
        - "balena-os/balena-dev"
        - "balenablocks/balena"
        - "company-os/balena-dev"
        - "people-os/balena-dev"
        - "product-os/balena-dev"

    options:
      <<: *options

  # allow forks but disallow comments and invalidate on push
  - name: members have approved fork

    if:
      # include forks in this rule
      from_branch:
        pattern: "^.+:.+$"
      # exclude the following repositories that require sudoers approval
      repository:
        not_matches:
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"

    requires:
      <<: *requireMembers

    options:
      allow_author: true
      allow_contributor: true
      # invalidate on push for forks
      invalidate_on_push: true

      methods:
        # disable comment approvals
        comments: []
        comment_patterns: []
        # allow github review approvals
        github_review: true

  - name: has renovate minor labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "minor"

  - name: has renovate patch labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "patch"

  - name: has renovate digest labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "digest"

  - name: has renovate pinDigest labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "pinDigest"

  - name: has renovate pin labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "pin"

  - name: has label no-review
    if:
      has_labels:
        - "no-review"
