policy:
  approval:
    - or:
        - sudoers have approved
        - team members have approved
        - team members have approved fork
        - has renovate minor labels
        - has renovate patch labels
        - has renovate digest labels
        - has renovate pinDigest labels
        - has renovate pin labels
        - has label no-review
  disapproval:
    requires:
      teams: &balenaTeams
        - "balena-fleetops/balena-dev"
        - "balena-io/balena-dev"
        - "balena-io-examples/balena-dev"
        - "balena-io-experimental/balena-dev"
        - "balena-io-hardware/balena-dev"
        - "balena-io-library/resin-dev"
        - "balena-io-modules/balena-dev"
        - "balena-labs-projects/balena-dev"
        - "balena-labs-research/balena-dev"
        - "balena-os/balena-dev"
        - "balenablocks/balena"
        - "company-os/balena-dev"
        - "people-os/balena-dev"
        - "product-os/balena-dev"
    options:
      # "methods" defines how users set and revoke disapproval.
      methods:
        # "disapprove" sets the methods for disapproval.
        disapprove:
          comments:
            - ":-1:"
            - "ðŸ‘Ž"
          github_review: true
        # "revoke" sets the methods for revoking disapproval. Usually, these will
        # match the methods used by approval rules.
        revoke:
          comments: []
          comment_patterns: &approvalPatterns
            - "^(?i)acked(-| )by:?\\s+" # eg. Acked-by: , acked by
            - "^(?i)(@balena-ci\\s+)?i self-certify!?$" # eg. @balena-ci I self-certify!, i self-certify
            - "^(?i)(@balena-ci\\s+)?approve this please!?$" # eg. @balena-ci Approve this please!, approve this please
            - "^(?i)lgtm!?$" # eg. LGTM, lgtm, Lgtm
          github_review: true

approval_rules:
  - name: sudoers have approved

    if:
      from_branch: &excludeForks
        pattern: "^[^:]+$"

    requires:
      count: 1
      teams:
        - "balenaltd/sudoers"

    options: &defaultOptions
      allow_author: true
      allow_contributor: true
      invalidate_on_push: false
      ignore_edited_comments: true

      methods:
        comments: []
        comment_patterns:
          *approvalPatterns
        github_review: true

  - name: team members have approved

    if:
      from_branch:
        <<: *excludeForks
      repository: &excludeRestrictedRepositories
        not_matches:
          - "product-os/policies"
          - "balenaltd/admins"
          - ".*/.github"

    requires:
      count: 1
      teams:
        *balenaTeams

    options:
      <<: *defaultOptions

  - name: team members have approved fork

    if:
      repository:
        <<: *excludeRestrictedRepositories

    requires:
      count: 1
      teams:
        *balenaTeams

    options:
      <<: *defaultOptions
      # invalidate on push for forks
      invalidate_on_push: true

  - name: has renovate minor labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "minor"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate patch labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "patch"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate digest labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "digest"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate pinDigest labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "pinDigest"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has renovate pin labels
    if:
      has_labels:
        - "renovate"
        - "dependencies"
        - "pin"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories

  - name: has label no-review
    if:
      has_labels:
        - "no-review"
      from_branch:
        <<: *excludeForks
      repository:
        <<: *excludeRestrictedRepositories
